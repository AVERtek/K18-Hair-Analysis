<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>K18 Hair Analysis</title>

    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.js"></script>

    <style>
        body { background-color: #00BBB4; margin: 0; padding: 15px; font-family: -apple-system, sans-serif; }
        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .card-white { background-color: #FFFFFF; border: 2px solid #00BBB9; padding: 5px; position: relative; border-radius: 8px; }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 10;
            display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 8px;
        }
        #overlay.hide { display: none; }
        .play-trigger { background: #ff595a; color: white; border: 1px solid white; padding: 12px 24px; border-radius: 8px; font-weight: bold; }

        /* HIDE NATIVE AR BUTTONS */
        model-viewer::part(default-ar-button) { display: none !important; }

        .ar-button { 
            background-color: #ff595a; border-radius: 8px; border: 1px solid white; 
            position: absolute; top: 10px; right: 10px; height: 40px; 
            color: white; padding: 0 15px; cursor: pointer; z-index: 15; font-weight: bold;
        }

        model-viewer { width: 100%; height: 500px; }
        .marginauto { margin: 10px auto; display: block; }
        .centerImage { text-align: center; }
    </style>
</head>

<body>
    <div class="container">
        <div class="card-white">
            <div id="overlay" onclick="startExperience()">
                <div class="play-trigger">CLICK TO START</div>
            </div>

            <model-viewer id="sync-model" 
                src="Models/K18_TEST_Ver.5.glb" 
                ios-src="Models/AR_57seconds_withoutBanner_WithAudioEN.usdz#allowsScaling=1"
                ar ar-modes="webxr quick-look scene-viewer" ar-scale="any" 
                camera-controls autoplay interaction-prompt="none">
                
                <button slot="ar-button" class="ar-button" id="ar-launcher">
                    ðŸ‘† <strong>AR CLICK HERE</strong>
                </button>
            </model-viewer>
        </div>

        <div style="text-align: center; background: #00BBB4; padding: 10px;">
            <h3 style="color: white;">LISTEN TO NARRATION</h3>
            <audio id="sound" style="width: 100%;" controls>
                <source id="audio-source" src="Sound/K18 VOICE.mp3" type="audio/mpeg">
            </audio>
        </div>
    </div>

    <script>
        const modelViewer = document.querySelector("#sync-model");
        const audio = document.querySelector("#sound");
        const audioSource = document.querySelector("#audio-source");
        const overlay = document.querySelector("#overlay");
        const arLauncher = document.querySelector("#ar-launcher");

        // Audio File Paths
        const webAudio = "Sound/K18 VOICE.mp3"; // 1:39 version
        const arAudio = "Sound/K18 Edit 57sec_3.mp3"; // 57s version

        function startExperience() {
            overlay.classList.add("hide");
            audio.play();
            modelViewer.play();
        }

        // --- AR LAUNCH LOGIC ---
        arLauncher.addEventListener('click', () => {
            // 1. Switch Audio to 57s version
            audio.pause();
            audioSource.src = arAudio;
            audio.load(); 

            // 2. Prime the new audio so it can autoplay in AR
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
            }).catch(e => console.log("Audio prime bypass"));

            // 3. Swap 3D Model Asset
            modelViewer.src = "Models/AR_57seconds_withoutBanner.glb";
            
            // 4. Launch AR
            modelViewer.activateAR();
        });

        // --- AR STATUS HANDLER ---
        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'object-placed') {
                audio.play();
                modelViewer.play();
            }

            // Reset back to 1:39 Web Version upon exit
            if (event.detail.status === 'not-presenting') {
                audio.pause();
                audioSource.src = webAudio;
                audio.load();
                modelViewer.src = "Models/K18_TEST_Ver.5.glb";
                
                // Show overlay again or auto-resume 1:39 audio
                setTimeout(() => {
                    audio.play();
                    modelViewer.play();
                }, 800);
            }
        });

        // Two-way slider sync (Only for the 1:39 web version)
        audio.addEventListener("timeupdate", () => {
            if (!isNaN(audio.currentTime) && modelViewer.src.includes("Ver.5")) {
                modelViewer.currentTime = audio.currentTime;
            }
        });

        audio.addEventListener("play", () => modelViewer.play());
        audio.addEventListener("pause", () => modelViewer.pause());
    </script>
</body>
</html>
